---
import Page from "@layouts/Page.astro";
import { S3Client, ListObjectsV2Command } from "@aws-sdk/client-s3";

const { slug } = Astro.params;
if (slug == undefined) return Astro.redirect("/404");

let photoUrl: string | null = null;
let photoKey: string | null = null;
let error: string | null = null;

const getVariable = (name: string) => import.meta.env.DEV
    ? import.meta.env[name]
    : Astro.locals.runtime?.env?.[name];

try {
    const client = new S3Client({
        region: "auto",
        endpoint: getVariable("R2_ENDPOINT"),
        credentials: {
            accessKeyId: getVariable("R2_ACCESS_KEY_ID"),
            secretAccessKey: getVariable("R2_ACCESS_SECRET_KEY")
        }
    });

    const response = await client.send(new ListObjectsV2Command({
        Bucket: getVariable("R2_BUCKET")
    }));

    if (response.Contents) {
        const photo = response.Contents
            .filter((obj: any) => obj.Key?.match(/\.(jpg|jpeg|png|gif|webp)$/i))
            .filter((obj: any) => !obj.Key?.startsWith("preview_"))
            .find((obj: any) => {
                const objSlug = obj.Key!.replace(/\.[^/.]+$/, "");
                return objSlug === slug;
            });

        if (photo) {
            photoKey = photo.Key!;
            photoUrl = `https://photos.mudkip.dev/${photoKey}`;
        } else {
            return Astro.redirect("/404");
        }
    } else {
        return Astro.redirect("/404");
    }
} catch (err) {
    error = "Failed to load photo!";
}
---
<Page title="photos" path={"~/photos/" + photoKey}>
    {error ? (
        <span class="error">{error}</span>
    ) : photoUrl ? (
        <div>
            <a href="/photos" class="button">‚Üê back to photos</a>
            <img src={photoUrl} />
        </div>
    ) : (
        <span class="error">Photo not found.</span>
    )}
</Page>

<style>
    div:not(.button) {
        display: flex;
        flex-direction: column;
        gap: 1em;
    }

    img {
        max-width: 100%;
        max-height: 70vh;
        object-fit: contain;
        display: block;
    }

    @media (max-width: 768px) {
        img {
            max-height: 50vh;
        }
    }
</style>
